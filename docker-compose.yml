services:
  odoo:
    build:
      context: .                   # ğŸ“‚ Usa la carpeta raÃ­z como contexto de construcciÃ³n
      dockerfile: Dockerfile.odoo  # ğŸ› ï¸ Especifica el Dockerfile para Odoo
    env_file:
      - .env                       # ğŸ”¹ Carga las variables generales desde el archivo `.env`
    volumes:
      - ./entrypoint_odoo.sh:/entrypoint.sh:ro           # ğŸš€ Script de inicio para Odoo
      - ./config/odoo.conf.tpl:/config/odoo.conf.tpl:ro  # ğŸ“œ ConfiguraciÃ³n dinÃ¡mica de Odoo
      - ./addons:/mnt/custom-addons                      # ğŸ”Œ Monta los mÃ³dulos personalizados
      - ./odoo-src:/usr/lib/python3/dist-packages/odoo   # ğŸ–¥ï¸ Acceso al cÃ³digo fuente de Odoo
      - ./data:/var/lib/odoo                             # ğŸ’¾ Almacena datos persistentes de Odoo
    entrypoint: ["/entrypoint.sh"]  # ğŸ Ejecuta el script de entrada
    depends_on:
      postgres:
        condition: service_healthy  # âœ… Espera a que PostgreSQL estÃ© listo
      redis:
        condition: service_healthy  # âœ… Espera a que Redis estÃ© listo
    networks:
      - odoo-network  # ğŸŒ ConexiÃ³n a la red de Odoo

  postgres:
    image: postgres:16                            # ğŸ˜ Usa la imagen oficial de PostgreSQL 16
    container_name: ${INSTANCE:-prueba}-postgres  # ğŸ·ï¸ Nombre del contenedor con prefijo de instancia
    restart: unless-stopped                       # ğŸ”„ Reiniciar a menos que se detenga manualmente
    environment:
      - POSTGRES_USER=odoo               # ğŸ‘¤ Usuario de PostgreSQL
      - POSTGRES_PASSWORD=odoo_password  # ğŸ”‘ ContraseÃ±a de PostgreSQL
      - POSTGRES_DB=odoo                 # ğŸ“‚ Base de datos de Odoo
    volumes:
      - ./data/postgres:/var/lib/postgresql/data  # ğŸ’¾ Datos persistentes de PostgreSQL
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "odoo"]  # ğŸ©º Verifica si PostgreSQL estÃ¡ listo
      interval: 10s                              # â³ VerificaciÃ³n cada 10 segundos
      retries: 5                                 # ğŸ”„ Reintentos en caso de fallo
    networks:
      - odoo-network  # ğŸŒ ConexiÃ³n a la red de Odoo

  redis:
    image: redis:latest                        # ğŸš€ Usa la imagen oficial de Redis
    container_name: ${INSTANCE:-prueba}-redis  # ğŸ·ï¸ Nombre del contenedor con prefijo de instancia
    restart: unless-stopped                    # ğŸ”„ Reiniciar automÃ¡ticamente si falla
    command: redis-server --appendonly yes     # ğŸ› ï¸ Configura Redis para persistencia
    volumes:
      - ./data/redis:/data                # ğŸ’¾ Datos persistentes de Redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]  # ğŸ©º Verifica si Redis estÃ¡ activo
      interval: 10s                       # â³ VerificaciÃ³n cada 10 segundos
      retries: 5                          # ğŸ”„ Reintentos en caso de fallo
    networks:
      - odoo-network  # ğŸŒ ConexiÃ³n a la red de Odoo

  pgbackup:
    build:
      context: .                       # ğŸ“‚ Usa la carpeta raÃ­z como contexto de construcciÃ³n
      dockerfile: Dockerfile.pgbackup  # ğŸ› ï¸ Dockerfile para el servicio de copias de seguridad
    volumes:
      - ./backups:/backups             # ğŸ’¾ Almacena los backups en la carpeta local
    environment:
      - PGHOST=prueba-postgres      # ğŸ“Œ Servidor de PostgreSQL
      - PGUSER=odoo                 # ğŸ‘¤ Usuario de PostgreSQL
      - PGPASSWORD=odoo_password    # ğŸ”‘ ContraseÃ±a de PostgreSQL
      - PGDATABASE=odoo             # ğŸ“‚ Base de datos de Odoo
      - BACKUP_INTERVAL=86400       # â³ Intervalo entre backups (1 dÃ­a)
    depends_on:
      postgres:
        condition: service_healthy  # âœ… Espera a que PostgreSQL estÃ© listo
    networks:
      - odoo-network  # ğŸŒ ConexiÃ³n a la red de Odoo

networks:
  odoo-network:
    external: true  # ğŸŒ Usa una red compartida para conectar mÃºltiples proyectos
