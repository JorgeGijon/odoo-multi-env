# ğŸŒ Red compartida entre los servicios de Odoo
networks:
  odoo-network:
    external: true  # ğŸ”— Permite compartir la red con otros proyectos

services:
  # ğŸ—ï¸ ODOO - AplicaciÃ³n ERP
  odoo:
    build:
      context: .                   # ğŸ“‚ Usa la carpeta raÃ­z como contexto de construcciÃ³n
      dockerfile: Dockerfile.odoo  # ğŸ› ï¸ Especifica el Dockerfile para Odoo
    container_name: ${INSTANCE:-prueba}-odoo  # ğŸ·ï¸ Nombre dinÃ¡mico del contenedor
    restart: unless-stopped
    env_file:
      - .env  # ğŸ”¹ Carga las variables generales desde el archivo `.env`
    entrypoint: ["/entrypoint.sh"]  # ğŸ Ejecuta el script de entrada
    depends_on:
      postgres:
        condition: service_healthy  # âœ… Espera a que PostgreSQL estÃ© listo
      redis:
        condition: service_healthy  # âœ… Espera a que Redis estÃ© listo
    environment:
      # ğŸ–¼ï¸ ConfiguraciÃ³n de almacenamiento de archivos adjuntos
      - ATTACHMENT_STORAGE=db         # ğŸ“ Define si los adjuntos se guardan en la base de datos o en disco

      # ğŸš€ OptimizaciÃ³n de rendimiento
      - WORKERS=3                     # ğŸ”¹ NÃºmero de procesos trabajadores para manejar mÃºltiples solicitudes (Usa 3 de 4 CPUs)
      - MAX_CRON_THREADS=1            # â²ï¸ NÃºmero de hilos en procesos cron (Eficiencia en tareas programadas)
      - LIMIT_TIME_CPU=60             # â³ LÃ­mite de tiempo de CPU por solicitud en segundos
      - LIMIT_TIME_REAL=120           # â³ LÃ­mite de tiempo real por solicitud en segundos
      - LIMIT_MEMORY_SOFT=1000000000  # ğŸ’¾ LÃ­mite de memoria "suave" (1GB, Odoo intentarÃ¡ optimizar memoria)
      - LIMIT_MEMORY_HARD=1500000000  # ğŸ’¾ LÃ­mite de memoria "dura" (1.5GB, Odoo se reiniciarÃ¡ si lo supera)

      # ğŸ” Seguridad y conexiones
      - DB_SSLMODE=prefer                 # ğŸ” Habilita SSL si estÃ¡ disponible en PostgreSQL
      - PROXY_MODE=True                   # ğŸŒ Habilita el modo proxy para balanceadores de carga
      - DISABLE_SESSION_GC=True           # ğŸ›‘ Desactiva la recolecciÃ³n de sesiones para mejorar rendimiento
      - PYDEVD_DISABLE_FILE_VALIDATION=1  # âš™ï¸ Deshabilita validaciÃ³n de archivos en depuraciÃ³n   
    volumes:
      - ./entrypoint_odoo.sh:/entrypoint.sh:ro           # ğŸš€ Script de inicio para Odoo
      - ./data/config:/config                            # ğŸ“œ ConfiguraciÃ³n dinÃ¡mica (`odoo_dev.conf`, `odoo_prod.conf`)
      - ./addons:/mnt/custom-addons                      # ğŸ”Œ Monta los mÃ³dulos personalizados
      - ./odoo-src:/usr/lib/python3/dist-packages/odoo   # ğŸ–¥ï¸ Acceso al cÃ³digo fuente de Odoo
      - ./data/odoo:/var/lib/odoo                        # ğŸ’¾ Almacena datos persistentes de Odoo
      - ./data/filestore:/var/lib/odoo/filestore         # ğŸ“‚ Almacenamiento de archivos adjuntos
    networks:
      - odoo-network  # ğŸŒ ConexiÃ³n a la red de Odoo

  # ğŸ˜ POSTGRESQL - Base de datos
  postgres:
    image: postgres:16
    container_name: ${INSTANCE:-prueba}-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-odoo}                   # ğŸ‘¤ Usuario de PostgreSQL
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-odoo_password}  # ğŸ”‘ ContraseÃ±a de PostgreSQL
      - POSTGRES_DB=${POSTGRES_DB:-odoo}                       # ğŸ“‚ Base de datos de Odoo
      # âš™ï¸ ConfiguraciÃ³n de optimizaciÃ³n de PostgreSQL (Ajustada para 4 CPU / 4GB RAM)
      - POSTGRES_SHARED_BUFFERS=1GB                    # ğŸ’¾ Memoria compartida (25% de RAM disponible)
      - POSTGRES_WORK_MEM=32MB                         # ğŸ’¾ Memoria por operaciÃ³n (Mayor rendimiento en consultas grandes)
      - POSTGRES_MAINTENANCE_WORK_MEM=128MB            # ğŸ› ï¸ Memoria para mantenimiento (VACUUM, ANALYZE)
      - POSTGRES_MAX_CONNECTIONS=60                    # ğŸ”— MÃ¡ximo de conexiones simultÃ¡neas (Ajustado a carga media)
      - POSTGRES_EFFECTIVE_CACHE_SIZE=2GB              # ğŸ› ï¸ CachÃ© efectiva (~50% de la RAM restante)
      - POSTGRES_DEFAULT_STATISTICS_TARGET=100         # ğŸ“Š OptimizaciÃ³n de consultas
      - POSTGRES_AUTOVACUUM_MAX_WORKERS=3              # ğŸ› ï¸ Control de autovacuum (Balanceado)
      - POSTGRES_AUTOVACUUM_VACUUM_SCALE_FACTOR=0.08   # ğŸ”„ Frecuencia de VACUUM
      - POSTGRES_AUTOVACUUM_ANALYZE_SCALE_FACTOR=0.04  # ğŸ”„ Frecuencia de ANALYZE
      - POSTGRES_AUTOVACUUM_FREEZE_MAX_AGE=150000000   # ğŸ”„ ReducciÃ³n del freeze_max_age para estabilidad
      - POSTGRES_HOST_AUTH_METHOD=md5                  # ğŸ” Habilitar autenticaciÃ³n segura
      - POSTGRES_INITDB_ARGS=--data-checksums          # ğŸ› ï¸ Habilitar checksums en la base de datos
    volumes:
      - ./data/postgres:/var/lib/postgresql/data  # ğŸ’¾ Datos persistentes de PostgreSQL
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${POSTGRES_USER:-odoo}"]  # ğŸ©º Verifica si PostgreSQL estÃ¡ listo
      interval: 10s                              # â³ VerificaciÃ³n cada 10 segundos
      retries: 5                                 # ğŸ”„ Reintentos en caso de fallo
    networks:
      - odoo-network  # ğŸŒ ConexiÃ³n a la red de Odoo

  # ğŸ”´ REDIS - CachÃ© y almacenamiento de sesiones
  redis:
    image: redis:latest
    container_name: ${INSTANCE:-prueba}-redis
    restart: unless-stopped
    command: redis-server --appendonly yes  # ğŸ› ï¸ Configura Redis para persistencia
    volumes:
      - ./data/redis:/data  # ğŸ’¾ Datos persistentes de Redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]  # ğŸ©º Verifica si Redis estÃ¡ activo
      interval: 10s                       # â³ VerificaciÃ³n cada 10 segundos
      retries: 5                          # ğŸ”„ Reintentos en caso de fallo
    networks:
      - odoo-network  # ğŸŒ ConexiÃ³n a la red de Odoo

  # ğŸ›¢ï¸ PGBackup - Backups automÃ¡ticos de PostgreSQL
  pgbackup:
    build:
      context: .  # ğŸ“‚ Usa la carpeta raÃ­z como contexto de construcciÃ³n
      dockerfile: Dockerfile.pgbackup  # ğŸ› ï¸ Dockerfile del servicio de backup
    container_name: ${INSTANCE:-prueba}-pgbackup
    restart: unless-stopped
    entrypoint: ["/entrypoint_pgbackup.sh"]  # ğŸš€ Script de inicio de backups
    environment:
      - PGHOST=${INSTANCE:-prueba}-postgres      # ğŸ“Œ Servidor de PostgreSQL
      - PGUSER=${POSTGRES_USER:-odoo}            # ğŸ‘¤ Usuario de PostgreSQL
      - PGPASSWORD=${POSTGRES_PASSWORD:-odoo_password}    # ğŸ”‘ ContraseÃ±a de PostgreSQL
      - PGDATABASE=${POSTGRES_DB:-odoo}         # ğŸ“‚ Base de datos de Odoo
      - BACKUP_INTERVAL=${BACKUP_INTERVAL:-86400}       # â³ Intervalo entre backups (1 dÃ­a)
    depends_on:
      postgres:
        condition: service_healthy  # âœ… Espera a que PostgreSQL estÃ© listo
    volumes:
      - ./backups:/backups  # ğŸ’¾ Carpeta local para backups
    networks:
      - odoo-network  # ğŸŒ ConexiÃ³n a la red de Odoo

  # ğŸŒ NGINX - Proxy inverso para manejar trÃ¡fico de Stage y Prod
  nginx:
    image: nginx:latest
    container_name: ${INSTANCE:-prueba}-nginx
    restart: always
    profiles:
      - "stage"
      - "prod"  # ğŸ”¥ Se activa solo en estos entornos
    volumes:
      - ./config/nginx.conf:/etc/nginx/conf.d/default.conf:ro  # ğŸ“‚ ConfiguraciÃ³n de Nginx
    depends_on:
      - odoo
    networks:
      - odoo-network  # ğŸŒ ConexiÃ³n a la red de Odoo
    ports:
      - "80:80"  # ğŸ“Œ Redirige trÃ¡fico HTTP a Odoo
