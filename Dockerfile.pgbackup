# ğŸ“Œ Dockerfile para servicio de backup de PostgreSQL basado en PostgreSQL 16
# Este archivo configura un contenedor optimizado para gestionar backups automÃ¡ticos de la base de datos.

# ğŸ—ï¸ Usa la imagen oficial de PostgreSQL 16 para backups
FROM postgres:16

# ğŸ› ï¸ Ejecutar como root para configurar entorno
USER root

# ğŸ”„ Configurar entorno sin prompts interactivos
ENV DEBIAN_FRONTEND=noninteractive

# ğŸ“‚ Crear directorio para backups y ajustar permisos adecuados
RUN mkdir -p /backups && chmod -R 777 /backups && chown -R postgres:postgres /backups

# ğŸ”¹ Definir variables de entorno para control de backups
ARG BACKUP_INTERVAL=86400  # â³ Intervalo de backups en segundos (1 dÃ­a por defecto)
ENV BACKUP_INTERVAL=${BACKUP_INTERVAL}

# ğŸ”§ Copiar el script de backup y asignar permisos de ejecuciÃ³n
COPY entrypoint_pgbackup.sh /entrypoint_pgbackup.sh
RUN chmod +x /entrypoint_pgbackup.sh

# ğŸ” HEALTHCHECK para verificar que se generan backups correctamente
HEALTHCHECK --interval=1h --timeout=30s --retries=3 \
    CMD test -f /backups/latest_backup.sql || exit 1

# ğŸ‘¤ Cambiar al usuario 'postgres' para la ejecuciÃ³n segura del contenedor
USER postgres

# ğŸ Definir el entrypoint del contenedor para ejecuciÃ³n automÃ¡tica de backups
ENTRYPOINT ["/entrypoint_pgbackup.sh"]
