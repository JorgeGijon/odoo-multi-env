# ğŸ“Œ Dockerfile para Odoo personalizado basado en Odoo 18 con Ubuntu 24.04
# Este archivo construye una imagen optimizada de Odoo con soporte para DebugPy y mÃ³dulos personalizados.

# ğŸ—ï¸ Usa la imagen oficial de Odoo 18 basada en Ubuntu 24.04
FROM odoo:18

# ğŸ› ï¸ Ejecutar como root para instalar dependencias del sistema
USER root

# ğŸ”„ Configurar entorno sin prompts interactivos
ENV DEBIAN_FRONTEND=noninteractive

# ğŸ”¹ Instalar paquetes esenciales para Odoo y DebugPy
RUN apt-get update && apt-get install -y --no-install-recommends \
    gettext-base curl git vim nano \  
   libpq-dev python3-venv python3-dev \  
   && rm -rf /var/lib/apt/lists/*  

# ğŸ Crear entorno virtual de Python y actualizar `pip`
RUN python3 -m venv /opt/venv
RUN /opt/venv/bin/pip install --upgrade pip && /opt/venv/bin/pip install debugpy

# ğŸ—ï¸ Configurar PATH para que use el entorno virtual
ENV PATH="/opt/venv/bin:$PATH"

# ğŸ”Œ Copiar mÃ³dulos personalizados a la carpeta de addons de Odoo
COPY --chown=odoo:odoo /custom_addons /mnt/custom-addons

# ğŸ”§ Copiar configuraciÃ³n de Odoo y asignar permisos adecuados
COPY ./config/odoo.conf /etc/odoo/odoo.conf
RUN chown -R odoo:odoo /etc/odoo/odoo.conf

# ğŸ“‚ Ajustar permisos de directorios crÃ­ticos para evitar problemas de acceso
RUN mkdir -p /var/lib/odoo/filestore && chmod -R 777 /var/lib/odoo/filestore
RUN mkdir -p /backups && chmod -R 777 /backups && chown -R odoo:odoo /backups

# ğŸ” HEALTHCHECK para verificar que Odoo estÃ¡ operativo
HEALTHCHECK --interval=30s --timeout=10s --retries=5 \
    CMD curl -f http://localhost:8069 || exit 1

# ğŸ”§ Copiar el script de entrada y asignar permisos de ejecuciÃ³n
COPY entrypoint_odoo.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# ğŸ‘¤ Cambiar al usuario 'odoo' para la ejecuciÃ³n segura del contenedor
USER odoo

# ğŸ Definir el entrypoint del contenedor
ENTRYPOINT ["/entrypoint.sh"]

# ğŸš€ Comando por defecto para ejecutar Odoo
CMD ["odoo"]
